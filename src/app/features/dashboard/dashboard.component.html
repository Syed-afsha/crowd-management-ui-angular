<div class="dashboard" [class.loading-overlay-active]="loading">
  <!-- Overall Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Loading dashboard...</p>
  </div>

  <div class="section-header">
    <h2>Overview</h2>
    <div class="date-picker-container">
      <mat-form-field class="date-form-field">
        <input 
          matInput
          [matDatepicker]="picker" 
          [value]="selectedDate"
          (dateChange)="onDateChange($event.value)"
          class="date-input"
          readonly>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
      <button 
        class="date-picker-btn" 
        (click)="picker.open()"
        type="button">
        <mat-icon class="calendar-icon">calendar_today</mat-icon>
        <span>{{ dateDisplayText }}</span>
      </button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="card">
      <div class="stat-title">Live Occupancy</div>
      <div class="stat-value" [class.loading-state]="loadingFootfall">{{ liveOccupancy }}</div>
      <div *ngIf="liveOccupancyChange" class="stat-percentage-change">
        {{ liveOccupancyChange.value.toFixed(0) }}% {{ liveOccupancyChange.isPositive ? 'More' : 'Less' }} than yesterday
      </div>
    </div>

    <div class="card">
      <div class="stat-title">Today's Footfall</div>
      <div class="stat-value" [class.loading-state]="loadingFootfall">
        <span *ngIf="!loadingFootfall">{{ footfallDisplayValue }}</span>
        <mat-spinner *ngIf="loadingFootfall" diameter="24" class="inline-spinner"></mat-spinner>
      </div>
      <div *ngIf="footfallChange && !loadingFootfall" class="stat-percentage-change">
        {{ footfallChange.value.toFixed(0) }}% {{ footfallChange.isPositive ? 'More' : 'Less' }} than yesterday
      </div>
    </div>

    <div class="card">
      <div class="stat-title">Avg Dwell Time</div>
      <div class="stat-value" [class.loading-state]="loadingDwell">
        <span *ngIf="!loadingDwell">{{ dwellTimeDisplayValue }}</span>
        <mat-spinner *ngIf="loadingDwell" diameter="24" class="inline-spinner"></mat-spinner>
      </div>
      <div *ngIf="dwellTimeChange && !loadingDwell" class="stat-percentage-change">
        {{ dwellTimeChange.value.toFixed(0) }}% {{ dwellTimeChange.isPositive ? 'More' : 'Less' }} than yesterday
      </div>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-header">
      <div class="stat-title">Overall Occupancy</div>
    </div>
    <div class="chart-container-wrapper">
      <div *ngIf="loadingOccupancy" class="chart-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p class="chart-loading-text">Loading occupancy data...</p>
      </div>
      <div class="chart-with-live-marker" *ngIf="occupancyChartData.length > 0 && occupancyChartData[0]?.series?.length >= 1 && !loadingOccupancy">
        <ngx-charts-area-chart
          [view]="chartOptions.view || [800, 300]"
          [scheme]="'vivid'"
          [results]="occupancyChartData"
          [gradient]="true"
          [curve]="curve"
          [xAxis]="chartOptions.showXAxis"
          [yAxis]="chartOptions.showYAxis"
          [legend]="chartOptions.showLegend"
          [showXAxisLabel]="chartOptions.showXAxisLabel"
          [showYAxisLabel]="chartOptions.showYAxisLabel"
          [xAxisLabel]="chartOptions.xAxisLabel"
          [yAxisLabel]="'Occupancy'"
          [autoScale]="chartOptions.autoScale"
          [timeline]="chartOptions.timeline"
          [animations]="chartOptions.animations">
        </ngx-charts-area-chart>
        <!-- LIVE Marker Line -->
        <div 
          *ngIf="liveMarkerPosition !== null" 
          class="live-marker-line"
          [style.left.%]="liveMarkerPosition">
          <div class="live-marker-label">LIVE</div>
        </div>
      </div>
      <div *ngIf="occupancyChartData.length === 0 && !loadingOccupancy" class="no-data">
        <mat-icon class="no-data-icon">bar_chart</mat-icon>
        <h3>No Occupancy Data</h3>
        <p>No occupancy data available for {{ dateDisplayText }}.</p>
        <p class="no-data-hint">Try selecting a different date.</p>
      </div>
    </div>
  </div>

  <h3 class="demographics-title">Demographics</h3>
  <div class="demographics-grid">
    <div class="card">
      <div class="stat-title">Chart of Demographics</div>
      <div class="donut-container">
        <div *ngIf="loadingDemographics" class="chart-loading chart-loading-center">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        <ngx-charts-pie-chart
          *ngIf="demographicsAnalysisChartData.length > 0 && !loadingDemographics"
          [view]="pieChartOptions.view"
          [scheme]="'vivid'"
          [results]="demographicsAnalysisChartData"
          [legend]="false"
          [labels]="false"
          [doughnut]="true"
          [animations]="pieChartOptions.animations">
        </ngx-charts-pie-chart>
        <div *ngIf="demographicsAnalysisChartData.length > 0 && !loadingDemographics" class="donut-center-text">
          <div class="donut-center-value">{{ totalCrowdPercentage }}%</div>
          <div class="donut-center-label">Total Crowd</div>
        </div>
        <div *ngIf="demographicsAnalysisChartData.length === 0 && !loadingDemographics" class="no-data-small">No data</div>
      </div>
      <div class="demographics-legend" *ngIf="!loadingDemographics && demographicsAnalysisChartData.length > 0">
        <div class="legend-item">
          <mat-icon class="legend-icon male">male</mat-icon>
          <div class="legend-details">
            <span class="legend-percentage">{{ malePercentage }}%</span>
            <span class="legend-count">({{ totalMaleCount | number }} people)</span>
          </div>
        </div>
        <div class="legend-item">
          <mat-icon class="legend-icon female">female</mat-icon>
          <div class="legend-details">
            <span class="legend-percentage">{{ femalePercentage }}%</span>
            <span class="legend-count">({{ totalFemaleCount | number }} people)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card demographics-analysis-card">
      <div class="stat-title">
        Demographics Analysis
      </div>
      <div class="chart-container-wrapper">
        <div *ngIf="loadingDemographics" class="chart-loading">
          <mat-spinner diameter="40"></mat-spinner>
          <p class="chart-loading-text">Loading demographics data...</p>
        </div>
      <ngx-charts-area-chart
          *ngIf="demographicsChartData.length > 0 && demographicsChartData[0]?.series?.length >= 1 && !loadingDemographics"
        [view]="demographicsChartOptions.view || [600, 300]"
        [scheme]="'vivid'"
        [results]="demographicsChartData"
        [gradient]="true"
        [curve]="curve"
        [xAxis]="demographicsChartOptions.showXAxis"
        [yAxis]="demographicsChartOptions.showYAxis"
        [legend]="false"
        [showXAxisLabel]="demographicsChartOptions.showXAxisLabel"
        [showYAxisLabel]="demographicsChartOptions.showYAxisLabel"
        [xAxisLabel]="demographicsChartOptions.xAxisLabel"
        [yAxisLabel]="'Count'"
        [autoScale]="demographicsChartOptions.autoScale"
        [timeline]="demographicsChartOptions.timeline"
        [animations]="demographicsChartOptions.animations">
      </ngx-charts-area-chart>
      <div *ngIf="demographicsChartData.length === 0 && !loadingDemographics" class="no-data">
        <mat-icon class="no-data-icon">people</mat-icon>
        <h3>No Demographics Data</h3>
        <p>No demographics data available for {{ dateDisplayText }}.</p>
        <p class="no-data-hint">Try selecting a different date.</p>
      </div>
      </div>
    </div>
  </div>
</div>
